version: '3'

vars:
  PROJECT_NAME: cc-registry-v2
  COMPOSE_FILE: docker-compose.yml

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # Main lifecycle commands
  start:
    desc: Start all services
    cmds:
      - echo "ğŸš€ Starting all services..."
      - docker-compose up -d --build

  stop:
    desc: Stop all services
    cmds:
      - echo "ğŸ›‘ Stopping all services..."
      - docker-compose down

  restart:
    desc: Restart all services
    cmds:
      - echo "ğŸ”„ Restarting all services..."
      - docker-compose restart

  # Monitoring commands
  logs:
    desc: Show logs for all services
    cmds:
      - docker-compose logs -f

  logs:service:
    desc: Show logs for a specific service
    cmds:
      - docker-compose logs -f {{.SERVICE}}
    vars:
      SERVICE: '{{.SERVICE | default "backend"}}'

  status:
    desc: Show service status
    cmds:
      - echo "ğŸ“Š Service Status:"
      - docker-compose ps

  # Build commands
  build:
    desc: Build all services
    cmds:
      - echo "ğŸ—ï¸  Building all services..."
      - docker-compose build

  build:service:
    desc: Build a specific service
    cmds:
      - echo "ğŸ—ï¸  Building {{.SERVICE}}..."
      - docker-compose build {{.SERVICE}}
    vars:
      SERVICE: '{{.SERVICE | default "backend"}}'

  # Cleanup commands
  clean:
    desc: Clean up Docker resources
    cmds:
      - echo "ğŸ§¹ Cleaning up Docker resources..."
      - docker-compose down -v
      - docker system prune -f

  clean:all:
    desc: Clean up everything (including images)
    cmds:
      - echo "ğŸ§¹ Cleaning up everything..."
      - docker-compose down -v --rmi all
      - docker system prune -af

  # Individual service groups
  backend:
    desc: Start only backend services (db, redis, backend)
    cmds:
      - echo "ğŸ”§ Starting backend services..."
      - docker-compose up -d database redis backend

  frontend:
    desc: Start only frontend (requires backend)
    cmds:
      - echo "ğŸ¨ Starting frontend..."
      - docker-compose up -d frontend

  workers:
    desc: Start worker services
    cmds:
      - echo "ğŸ”„ Starting worker services..."
      - docker-compose up -d worker scheduler flower

  # Development commands
  dev:
    desc: Start development environment (backend + frontend)
    cmds:
      - echo "ğŸ’» Starting development environment..."
      - docker-compose up -d database redis backend frontend

  dev:logs:
    desc: Show logs for development services
    cmds:
      - docker-compose logs -f backend frontend

  dev:restart:
    desc: Restart development services
    cmds:
      - docker-compose restart backend frontend

  # Database commands
  db:shell:
    desc: Connect to database shell
    cmds:
      - docker-compose exec database psql -U user -d codecollection_registry

  db:backup:
    desc: Backup database
    cmds:
      - echo "ğŸ’¾ Creating database backup..."
      - docker-compose exec database pg_dump -U user codecollection_registry > backup_$(date +%Y%m%d_%H%M%S).sql

  # Health checks
  health:
    desc: Check health of all services
    cmds:
      - echo "ğŸ¥ Checking service health..."
      - |
        echo "Database:" && curl -s http://localhost:5432 > /dev/null && echo "âœ… Reachable" || echo "âŒ Not reachable"
        echo "Redis:" && docker-compose exec redis redis-cli ping && echo "âœ… Redis OK" || echo "âŒ Redis down"
        echo "Backend:" && curl -s http://localhost:8001/api/v1/health | jq -r '.status' && echo "âœ… Backend OK" || echo "âŒ Backend down"
        echo "Frontend:" && curl -s http://localhost:3000 > /dev/null && echo "âœ… Frontend OK" || echo "âŒ Frontend down"

  # Container image commands
  image:build:
    desc: Build all container images with tags
    cmds:
      - echo "ğŸ³ Building container images..."
      - docker build -t cc-registry-v2-backend:{{.TAG}} ./backend
      - docker build -t cc-registry-v2-frontend:{{.TAG}} ./frontend
      - docker build -t cc-registry-v2-worker:{{.TAG}} ./worker
      - echo "âœ… All images built successfully"
    vars:
      TAG: '{{.TAG | default "latest"}}'

  image:build:backend:
    desc: Build backend image
    cmds:
      - echo "ğŸ³ Building backend image..."
      - docker build -t cc-registry-v2-backend:{{.TAG}} ./backend
    vars:
      TAG: '{{.TAG | default "latest"}}'

  image:build:frontend:
    desc: Build frontend image
    cmds:
      - echo "ğŸ³ Building frontend image..."
      - docker build -t cc-registry-v2-frontend:{{.TAG}} ./frontend
    vars:
      TAG: '{{.TAG | default "latest"}}'

  image:build:worker:
    desc: Build worker image
    cmds:
      - echo "ğŸ³ Building worker image..."
      - cp backend/requirements.txt worker/requirements.txt
      - docker build -t cc-registry-v2-worker:{{.TAG}} ./worker
    vars:
      TAG: '{{.TAG | default "latest"}}'

  image:tag:
    desc: Tag images for registry push (set REGISTRY and TAG vars)
    cmds:
      - echo "ğŸ·ï¸  Tagging images for {{.REGISTRY}}..."
      - docker tag cc-registry-v2-backend:latest {{.REGISTRY}}/cc-registry-v2-backend:{{.TAG}}
      - docker tag cc-registry-v2-frontend:latest {{.REGISTRY}}/cc-registry-v2-frontend:{{.TAG}}
      - docker tag cc-registry-v2-worker:latest {{.REGISTRY}}/cc-registry-v2-worker:{{.TAG}}
      - echo "âœ… Images tagged"
    vars:
      REGISTRY: '{{.REGISTRY | default "ghcr.io/OWNER/REPO"}}'
      TAG: '{{.TAG | default "latest"}}'

  image:push:
    desc: Push images to registry (set REGISTRY and TAG vars)
    cmds:
      - echo "ğŸ“¤ Pushing images to {{.REGISTRY}}..."
      - docker push {{.REGISTRY}}/cc-registry-v2-backend:{{.TAG}}
      - docker push {{.REGISTRY}}/cc-registry-v2-frontend:{{.TAG}}
      - docker push {{.REGISTRY}}/cc-registry-v2-worker:{{.TAG}}
      - echo "âœ… Images pushed successfully"
    vars:
      REGISTRY: '{{.REGISTRY | default "ghcr.io/OWNER/REPO"}}'
      TAG: '{{.TAG | default "latest"}}'

  image:publish:
    desc: Build, tag, and push all images (set REGISTRY and TAG vars)
    cmds:
      - task: image:build
        vars:
          TAG: "{{.TAG}}"
      - task: image:tag
        vars:
          REGISTRY: "{{.REGISTRY}}"
          TAG: "{{.TAG}}"
      - task: image:push
        vars:
          REGISTRY: "{{.REGISTRY}}"
          TAG: "{{.TAG}}"
      - echo "âœ… All images published to {{.REGISTRY}}"
    vars:
      REGISTRY: '{{.REGISTRY | default "ghcr.io/OWNER/REPO"}}'
      TAG: '{{.TAG | default "latest"}}'

  # Kubernetes preparation
  k8s:export:
    desc: Export Docker Compose to Kubernetes manifests (requires kompose)
    cmds:
      - |
        if command -v kompose >/dev/null 2>&1; then
          echo "ğŸ“¦ Exporting to Kubernetes manifests..."
          kompose convert -f {{.COMPOSE_FILE}} -o k8s/generated/
          echo "âœ… Kubernetes manifests generated in k8s/generated/ directory"
        else
          echo "âŒ kompose not installed."
          echo "Install with: curl -L https://github.com/kubernetes/kompose/releases/latest/download/kompose-linux-amd64 -o kompose && chmod +x kompose && sudo mv kompose /usr/local/bin/"
        fi

  k8s:update-images:
    desc: Update image references in k8s manifests (set REGISTRY and TAG vars)
    cmds:
      - echo "ğŸ”„ Updating image references in k8s manifests..."
      - |
        cd k8s
        find . -type f -name "*.yaml" ! -name "secrets-example.yaml" -exec sed -i \
          's|ghcr.io/OWNER/REPO/cc-registry-v2-\(.*\):.*|{{.REGISTRY}}/cc-registry-v2-\1:{{.TAG}}|g' {} +
      - echo "âœ… Image references updated"
    vars:
      REGISTRY: '{{.REGISTRY | default "ghcr.io/OWNER/REPO"}}'
      TAG: '{{.TAG | default "latest"}}'

  k8s:validate:
    desc: Validate Kubernetes manifests
    cmds:
      - echo "ğŸ” Validating Kubernetes manifests..."
      - kubectl apply --dry-run=client -k k8s/
      - echo "âœ… Manifests are valid"

  k8s:setup:
    desc: Setup Kubernetes namespace and secrets
    cmds:
      - echo "ğŸ”§ Setting up Kubernetes namespace..."
      - kubectl create namespace codecollection-registry --dry-run=client -o yaml | kubectl apply -f -
      - echo "âš ï¸  Don't forget to create secrets! See k8s/secrets-example.yaml"
      - echo "âš ï¸  Create image pull secret with: kubectl create secret docker-registry ghcr-pull-secret ..."

  k8s:deploy:
    desc: Deploy to Kubernetes cluster using kustomize
    cmds:
      - echo "ğŸš€ Deploying to Kubernetes..."
      - kubectl apply -k k8s/
      - echo "âœ… Deployed successfully"
      - echo "ğŸ“Š Check status with: kubectl get all -n codecollection-registry"

  k8s:deploy:quick:
    desc: Build, push, and deploy to Kubernetes (set REGISTRY and TAG vars)
    cmds:
      - task: image:publish
        vars:
          REGISTRY: "{{.REGISTRY}}"
          TAG: "{{.TAG}}"
      - task: k8s:update-images
        vars:
          REGISTRY: "{{.REGISTRY}}"
          TAG: "{{.TAG}}"
      - task: k8s:deploy
      - echo "âœ… Complete deployment finished!"
    vars:
      REGISTRY: '{{.REGISTRY | default "ghcr.io/OWNER/REPO"}}'
      TAG: '{{.TAG | default "latest"}}'

  k8s:undeploy:
    desc: Remove from Kubernetes cluster
    cmds:
      - echo "ğŸ—‘ï¸  Removing from Kubernetes..."
      - kubectl delete -k k8s/
      - echo "âœ… Removed successfully"

  k8s:status:
    desc: Check deployment status in Kubernetes
    cmds:
      - echo "ğŸ“Š Kubernetes Deployment Status:"
      - kubectl get all -n codecollection-registry
      - echo ""
      - echo "ğŸ” Pod Status:"
      - kubectl get pods -n codecollection-registry -o wide

  k8s:logs:
    desc: Show logs from Kubernetes deployment (set SERVICE var)
    cmds:
      - kubectl logs -f deployment/cc-registry-{{.SERVICE}} -n codecollection-registry
    vars:
      SERVICE: '{{.SERVICE | default "backend"}}'

  k8s:restart:
    desc: Restart Kubernetes deployment (set SERVICE var or 'all')
    cmds:
      - |
        if [ "{{.SERVICE}}" = "all" ]; then
          echo "ğŸ”„ Restarting all deployments..."
          kubectl rollout restart deployment -n codecollection-registry
        else
          echo "ğŸ”„ Restarting {{.SERVICE}}..."
          kubectl rollout restart deployment/cc-registry-{{.SERVICE}} -n codecollection-registry
        fi
    vars:
      SERVICE: '{{.SERVICE | default "backend"}}'

  k8s:rollback:
    desc: Rollback Kubernetes deployment (set SERVICE var)
    cmds:
      - echo "âª Rolling back {{.SERVICE}}..."
      - kubectl rollout undo deployment/cc-registry-{{.SERVICE}} -n codecollection-registry
    vars:
      SERVICE: '{{.SERVICE | default "backend"}}'

  # Setup commands
  setup:
    desc: Initial setup (create .env, install dependencies)
    cmds:
      - |
        if [ ! -f .env ]; then
          echo "ğŸ“ Creating .env file from example..."
          cp env.example .env
          echo "âš ï¸  Please update .env file with your actual configuration values"
        else
          echo "âœ… .env file already exists"
        fi
      - echo "ğŸ”§ Setup complete!"

  # Quick commands
  up:
    desc: Alias for start
    cmds:
      - task start

  down:
    desc: Alias for stop
    cmds:
      - task stop

  ps:
    desc: Alias for status
    cmds:
      - task status
