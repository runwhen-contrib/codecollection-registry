version: '3'

vars:
  PROJECT_NAME: cc-registry-v2
  COMPOSE_FILE: docker-compose.yml

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  # Main lifecycle commands
  start:
    desc: Start all services
    cmds:
      - echo "ğŸš€ Starting all services..."
      - docker-compose up -d --build

  stop:
    desc: Stop all services
    cmds:
      - echo "ğŸ›‘ Stopping all services..."
      - docker-compose down

  restart:
    desc: Restart all services
    cmds:
      - echo "ğŸ”„ Restarting all services..."
      - docker-compose restart

  # Monitoring commands
  logs:
    desc: Show logs for all services
    cmds:
      - docker-compose logs -f

  logs:service:
    desc: Show logs for a specific service
    cmds:
      - docker-compose logs -f {{.SERVICE}}
    vars:
      SERVICE: '{{.SERVICE | default "backend"}}'

  status:
    desc: Show service status
    cmds:
      - echo "ğŸ“Š Service Status:"
      - docker-compose ps

  # Build commands
  build:
    desc: Build all services
    cmds:
      - echo "ğŸ—ï¸  Building all services..."
      - docker-compose build

  build:service:
    desc: Build a specific service
    cmds:
      - echo "ğŸ—ï¸  Building {{.SERVICE}}..."
      - docker-compose build {{.SERVICE}}
    vars:
      SERVICE: '{{.SERVICE | default "backend"}}'

  # Cleanup commands
  clean:
    desc: Clean up Docker resources
    cmds:
      - echo "ğŸ§¹ Cleaning up Docker resources..."
      - docker-compose down -v
      - docker system prune -f

  clean:all:
    desc: Clean up everything (including images)
    cmds:
      - echo "ğŸ§¹ Cleaning up everything..."
      - docker-compose down -v --rmi all
      - docker system prune -af

  # Individual service groups
  backend:
    desc: Start only backend services (db, redis, backend)
    cmds:
      - echo "ğŸ”§ Starting backend services..."
      - docker-compose up -d database redis backend

  frontend:
    desc: Start only frontend (requires backend)
    cmds:
      - echo "ğŸ¨ Starting frontend..."
      - docker-compose up -d frontend

  workers:
    desc: Start worker services
    cmds:
      - echo "ğŸ”„ Starting worker services..."
      - docker-compose up -d worker scheduler flower

  # Development commands
  dev:
    desc: Start development environment (backend + frontend)
    cmds:
      - echo "ğŸ’» Starting development environment..."
      - docker-compose up -d database redis backend frontend

  dev:logs:
    desc: Show logs for development services
    cmds:
      - docker-compose logs -f backend frontend

  dev:restart:
    desc: Restart development services
    cmds:
      - docker-compose restart backend frontend

  # Database commands
  db:shell:
    desc: Connect to database shell
    cmds:
      - docker-compose exec database psql -U user -d codecollection_registry

  db:backup:
    desc: Backup database
    cmds:
      - echo "ğŸ’¾ Creating database backup..."
      - docker-compose exec database pg_dump -U user codecollection_registry > backup_$(date +%Y%m%d_%H%M%S).sql

  # Health checks
  health:
    desc: Check health of all services
    cmds:
      - echo "ğŸ¥ Checking service health..."
      - |
        echo "Database:" && curl -s http://localhost:5432 > /dev/null && echo "âœ… Reachable" || echo "âŒ Not reachable"
        echo "Redis:" && docker-compose exec redis redis-cli ping && echo "âœ… Redis OK" || echo "âŒ Redis down"
        echo "Backend:" && curl -s http://localhost:8001/api/v1/health | jq -r '.status' && echo "âœ… Backend OK" || echo "âŒ Backend down"
        echo "Frontend:" && curl -s http://localhost:3000 > /dev/null && echo "âœ… Frontend OK" || echo "âŒ Frontend down"

  # Kubernetes preparation
  k8s:export:
    desc: Export Docker Compose to Kubernetes manifests (requires kompose)
    cmds:
      - |
        if command -v kompose >/dev/null 2>&1; then
          echo "ğŸ“¦ Exporting to Kubernetes manifests..."
          kompose convert -f {{.COMPOSE_FILE}} -o k8s/
          echo "âœ… Kubernetes manifests generated in k8s/ directory"
        else
          echo "âŒ kompose not installed."
          echo "Install with: curl -L https://github.com/kubernetes/kompose/releases/latest/download/kompose-linux-amd64 -o kompose && chmod +x kompose && sudo mv kompose /usr/local/bin/"
        fi

  k8s:deploy:
    desc: Deploy to Kubernetes cluster
    cmds:
      - echo "ğŸš€ Deploying to Kubernetes..."
      - kubectl apply -f k8s/

  k8s:undeploy:
    desc: Remove from Kubernetes cluster
    cmds:
      - echo "ğŸ—‘ï¸  Removing from Kubernetes..."
      - kubectl delete -f k8s/

  # Setup commands
  setup:
    desc: Initial setup (create .env, install dependencies)
    cmds:
      - |
        if [ ! -f .env ]; then
          echo "ğŸ“ Creating .env file from example..."
          cp env.example .env
          echo "âš ï¸  Please update .env file with your actual configuration values"
        else
          echo "âœ… .env file already exists"
        fi
      - echo "ğŸ”§ Setup complete!"

  # Quick commands
  up:
    desc: Alias for start
    cmds:
      - task start

  down:
    desc: Alias for stop
    cmds:
      - task stop

  ps:
    desc: Alias for status
    cmds:
      - task status
