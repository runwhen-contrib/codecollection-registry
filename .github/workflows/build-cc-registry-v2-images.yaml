name: Build CC-Registry-V2 Images (PR)

on:
  pull_request:
    paths:
      - 'cc-registry-v2/**'
      - '.github/workflows/build-cc-registry-v2-images.yaml'

  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      tag:
        description: 'Custom tag for images (default: branch-sha)'
        required: false
        type: string
      trigger_test_deploy:
        description: 'Trigger test environment deployment'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  GCP_PROJECT_ID: runwhen-nonprod-shared
  GCR_REGISTRY: us-docker.pkg.dev/runwhen-nonprod-shared/public-images
  IMAGE_PREFIX: cc-registry-v2

permissions:
  contents: read
  id-token: write
  pull-requests: write
  actions: read

jobs:
  generate-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      should_push: ${{ steps.push.outputs.should_push }}
    steps:
      - name: Generate tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="$(echo $GITHUB_HEAD_REF$GITHUB_REF_NAME | sed 's/[^a-zA-Z0-9]/-/g')-${GITHUB_SHA::8}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Determine push behavior
        id: push
        run: |
          if [ "${{ github.event.inputs.push_images }}" = "false" ]; then
            echo "should_push=false" >> $GITHUB_OUTPUT
          else
            echo "should_push=true" >> $GITHUB_OUTPUT
          fi

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [generate-tag]
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: cc-registry-v2/backend
          file: cc-registry-v2/backend/Dockerfile
          platforms: linux/amd64
          push: ${{ needs.generate-tag.outputs.should_push == 'true' }}
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ needs.generate-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [generate-tag]
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: cc-registry-v2/frontend
          file: cc-registry-v2/frontend/Dockerfile
          platforms: linux/amd64
          push: ${{ needs.generate-tag.outputs.should_push == 'true' }}
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ needs.generate-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  build-worker:
    name: Build Worker
    runs-on: ubuntu-latest
    needs: [generate-tag]
    steps:
      - uses: actions/checkout@v4

      - name: Copy backend requirements to worker context
        run: cp cc-registry-v2/backend/requirements.txt cc-registry-v2/worker/requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Worker
        uses: docker/build-push-action@v5
        with:
          context: cc-registry-v2/worker
          file: cc-registry-v2/worker/Dockerfile
          platforms: linux/amd64
          push: ${{ needs.generate-tag.outputs.should_push == 'true' }}
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:${{ needs.generate-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  # Trigger test environment deployment after successful image push
  deploy-to-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [generate-tag, build-backend, build-frontend, build-worker]
    if: needs.generate-tag.outputs.should_push == 'true'
    steps:
      - name: Trigger registry-test image update
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const tag = '${{ needs.generate-tag.outputs.tag }}';
            await github.rest.actions.createWorkflowDispatch({
              owner: 'runwhen',
              repo: 'infra-flux-nonprod-shared',
              workflow_id: 'update-registry-test-images.yaml',
              ref: 'main',
              inputs: {
                environment: 'test',
                backend_tag: tag,
                frontend_tag: tag,
                worker_tag: tag,
                pr_number: String(context.issue?.number || ''),
                branch_prefix: 'chore/registry-image-update'
              }
            });
            console.log(`Triggered test deploy with tag: ${tag}`);

  # Comment on PR with image info
  comment-on-pr:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [generate-tag, build-backend, build-frontend, build-worker, deploy-to-test]
    if: always() && github.event_name == 'pull_request' && needs.generate-tag.outputs.should_push == 'true'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ needs.generate-tag.outputs.tag }}';
            const registry = '${{ env.GCR_REGISTRY }}';
            const prefix = '${{ env.IMAGE_PREFIX }}';
            const buildOk = '${{ needs.build-backend.result }}' === 'success' &&
                            '${{ needs.build-frontend.result }}' === 'success' &&
                            '${{ needs.build-worker.result }}' === 'success';
            const deployOk = '${{ needs.deploy-to-test.result }}' === 'success';

            let body = `## Container Images Built\n\n` +
              `**Tag:** \`${tag}\`\n` +
              `**Build:** ${buildOk ? '✅ All images pushed' : '❌ Some builds failed'}\n` +
              `**Test Deploy:** ${deployOk ? '✅ Triggered' : '⚠️ Not triggered'}\n\n` +
              `| Image | Tag |\n` +
              `|-------|-----|\n` +
              `| \`${prefix}-backend\` | \`${tag}\` |\n` +
              `| \`${prefix}-frontend\` | \`${tag}\` |\n` +
              `| \`${prefix}-worker\` | \`${tag}\` |\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
