name: Build CC-Registry-V2 Container Images

on:
  push: 
  pull_request:
    paths:
      - 'cc-registry-v2/**'
      - '.github/workflows/build-cc-registry-v2-images.yaml'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      tag:
        description: 'Custom tag for images (default: branch-sha)'
        required: false
        type: string
      build_multiarch:
        description: 'Build multi-architecture images (amd64 + arm64)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  # Google Cloud / GCR Configuration
  GCP_PROJECT_ID: runwhen-nonprod-shared
  GCR_REGISTRY: us-docker.pkg.dev/runwhen-nonprod-shared/public-images  
  IMAGE_PREFIX: cc-registry-v2

permissions:
  contents: read
  id-token: write
  pull-requests: write
  security-events: write
  actions: read

jobs:
  # Security scanning
  scan-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Optional: Uncomment to enable Trivy scanning
      # - name: Run Trivy vulnerability scanner
      #   uses: aquasecurity/trivy-action@0.20.0
      #   with:
      #     scan-type: 'fs'
      #     ignore-unfixed: true
      #     format: 'sarif'
      #     output: 'trivy-results-repo.sarif'
      #     severity: 'CRITICAL,HIGH'
      # 
      # - name: Upload Trivy results to GitHub Security
      #   uses: github/codeql-action/upload-sarif@v3
      #   with:
      #     sarif_file: 'trivy-results-repo.sarif'

  # Generate tag for all builds
  generate-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      should_push: ${{ steps.push.outputs.should_push }}
    steps:
      - name: Generate tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="$(echo $GITHUB_REF_NAME | sed 's/[^a-zA-Z0-9]/-/g')-${GITHUB_SHA::8}"
          fi
          echo "TAG=${TAG}" | tee -a $GITHUB_ENV
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
      
      - name: Determine push behavior
        id: push
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.inputs.push_images }}" = "true" ]; then
              echo "should_push=true" >> $GITHUB_OUTPUT
            else
              echo "should_push=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_push=true" >> $GITHUB_OUTPUT
          fi

  # Build Backend (amd64)
  build-backend-amd64:
    name: Build Backend (amd64)
    runs-on: ubuntu-latest
    needs: [generate-tag, scan-repo]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        run: |
          docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder
          docker buildx inspect --bootstrap

      - name: Build and push Backend (amd64)
        if: needs.generate-tag.outputs.should_push == 'true'
        run: |
          cd cc-registry-v2/backend
          docker buildx build \
            --platform linux/amd64 \
            --push \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ needs.generate-tag.outputs.tag }}-amd64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --build-arg GITHUB_SHA="${GITHUB_SHA}" \
            --build-arg GITHUB_REF="${GITHUB_REF}" \
            -f Dockerfile .

      - name: Build Backend (amd64) - No push
        if: needs.generate-tag.outputs.should_push == 'false'
        run: |
          cd cc-registry-v2/backend
          docker buildx build \
            --platform linux/amd64 \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ needs.generate-tag.outputs.tag }}-amd64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            -f Dockerfile .

  # Build Backend (arm64) - optional
  build-backend-arm64:
    name: Build Backend (arm64)
    runs-on: ubuntu-24.04-arm
    needs: [generate-tag, scan-repo]
    if: github.event.inputs.build_multiarch == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        run: |
          docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder
          docker buildx inspect --bootstrap

      - name: Build and push Backend (arm64)
        run: |
          cd cc-registry-v2/backend
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ needs.generate-tag.outputs.tag }}-arm64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --build-arg GITHUB_SHA="${GITHUB_SHA}" \
            --build-arg GITHUB_REF="${GITHUB_REF}" \
            -f Dockerfile .

  # Build Frontend (amd64)
  build-frontend-amd64:
    name: Build Frontend (amd64)
    runs-on: ubuntu-latest
    needs: [generate-tag, scan-repo]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        run: |
          docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder
          docker buildx inspect --bootstrap

      - name: Build and push Frontend (amd64)
        if: needs.generate-tag.outputs.should_push == 'true'
        run: |
          cd cc-registry-v2/frontend
          docker buildx build \
            --platform linux/amd64 \
            --push \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ needs.generate-tag.outputs.tag }}-amd64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --build-arg GITHUB_SHA="${GITHUB_SHA}" \
            --build-arg GITHUB_REF="${GITHUB_REF}" \
            -f Dockerfile .

      - name: Build Frontend (amd64) - No push
        if: needs.generate-tag.outputs.should_push == 'false'
        run: |
          cd cc-registry-v2/frontend
          docker buildx build \
            --platform linux/amd64 \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ needs.generate-tag.outputs.tag }}-amd64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            -f Dockerfile .

  # Build Frontend (arm64) - optional
  build-frontend-arm64:
    name: Build Frontend (arm64)
    runs-on: ubuntu-24.04-arm
    needs: [generate-tag, scan-repo]
    if: github.event.inputs.build_multiarch == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        run: |
          docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder
          docker buildx inspect --bootstrap

      - name: Build and push Frontend (arm64)
        run: |
          cd cc-registry-v2/frontend
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ needs.generate-tag.outputs.tag }}-arm64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --build-arg GITHUB_SHA="${GITHUB_SHA}" \
            --build-arg GITHUB_REF="${GITHUB_REF}" \
            -f Dockerfile .

  # Build Worker (amd64)
  build-worker-amd64:
    name: Build Worker (amd64)
    runs-on: ubuntu-latest
    needs: [generate-tag, scan-repo]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy backend requirements to worker context
        run: |
          cp cc-registry-v2/backend/requirements.txt cc-registry-v2/worker/requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        run: |
          docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder
          docker buildx inspect --bootstrap

      - name: Build and push Worker (amd64)
        if: needs.generate-tag.outputs.should_push == 'true'
        run: |
          cd cc-registry-v2/worker
          docker buildx build \
            --platform linux/amd64 \
            --push \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:${{ needs.generate-tag.outputs.tag }}-amd64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --build-arg GITHUB_SHA="${GITHUB_SHA}" \
            --build-arg GITHUB_REF="${GITHUB_REF}" \
            -f Dockerfile .

      - name: Build Worker (amd64) - No push
        if: needs.generate-tag.outputs.should_push == 'false'
        run: |
          cd cc-registry-v2/worker
          docker buildx build \
            --platform linux/amd64 \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:${{ needs.generate-tag.outputs.tag }}-amd64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            -f Dockerfile .

  # Build Worker (arm64) - optional
  build-worker-arm64:
    name: Build Worker (arm64)
    runs-on: ubuntu-24.04-arm
    needs: [generate-tag, scan-repo]
    if: github.event.inputs.build_multiarch == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy backend requirements to worker context
        run: |
          cp cc-registry-v2/backend/requirements.txt cc-registry-v2/worker/requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        run: |
          docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder
          docker buildx inspect --bootstrap

      - name: Build and push Worker (arm64)
        run: |
          cd cc-registry-v2/worker
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --tag "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:${{ needs.generate-tag.outputs.tag }}-arm64" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --build-arg GITHUB_SHA="${GITHUB_SHA}" \
            --build-arg GITHUB_REF="${GITHUB_REF}" \
            -f Dockerfile .

  # Create multi-arch manifests
  publish-manifests:
    name: Publish Multi-Arch Manifests
    runs-on: ubuntu-latest
    needs: 
      - generate-tag
      - build-backend-amd64
      - build-frontend-amd64
      - build-worker-amd64
      - build-backend-arm64
      - build-frontend-arm64
      - build-worker-arm64
    if: |
      always() && 
      needs.generate-tag.outputs.should_push == 'true' &&
      (needs.build-backend-amd64.result == 'success' || needs.build-backend-amd64.result == 'skipped') &&
      (needs.build-frontend-amd64.result == 'success' || needs.build-frontend-amd64.result == 'skipped') &&
      (needs.build-worker-amd64.result == 'success' || needs.build-worker-amd64.result == 'skipped')
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Create and push Backend manifest
        run: |
          TAG="${{ needs.generate-tag.outputs.tag }}"
          FULL="${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend"
          
          if [ "${{ github.event.inputs.build_multiarch }}" = "true" ]; then
            # Multi-arch manifest
            docker buildx imagetools create \
              --tag "${FULL}:${TAG}" \
              "${FULL}:${TAG}-amd64" \
              "${FULL}:${TAG}-arm64"
          else
            # Single arch manifest (amd64 only)
            docker buildx imagetools create \
              --tag "${FULL}:${TAG}" \
              "${FULL}:${TAG}-amd64"
          fi
          
          docker buildx imagetools inspect "${FULL}:${TAG}"

      - name: Create and push Frontend manifest
        run: |
          TAG="${{ needs.generate-tag.outputs.tag }}"
          FULL="${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend"
          
          if [ "${{ github.event.inputs.build_multiarch }}" = "true" ]; then
            docker buildx imagetools create \
              --tag "${FULL}:${TAG}" \
              "${FULL}:${TAG}-amd64" \
              "${FULL}:${TAG}-arm64"
          else
            docker buildx imagetools create \
              --tag "${FULL}:${TAG}" \
              "${FULL}:${TAG}-amd64"
          fi
          
          docker buildx imagetools inspect "${FULL}:${TAG}"

      - name: Create and push Worker manifest
        run: |
          TAG="${{ needs.generate-tag.outputs.tag }}"
          FULL="${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker"
          
          if [ "${{ github.event.inputs.build_multiarch }}" = "true" ]; then
            docker buildx imagetools create \
              --tag "${FULL}:${TAG}" \
              "${FULL}:${TAG}-amd64" \
              "${FULL}:${TAG}-arm64"
          else
            docker buildx imagetools create \
              --tag "${FULL}:${TAG}" \
              "${FULL}:${TAG}-amd64"
          fi
          
          docker buildx imagetools inspect "${FULL}:${TAG}"

      - name: Comment on PR with image info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ needs.generate-tag.outputs.tag }}';
            const registry = '${{ env.GCR_REGISTRY }}';
            const prefix = '${{ env.IMAGE_PREFIX }}';
            const multiarch = '${{ github.event.inputs.build_multiarch }}' === 'true';
            const arch = multiarch ? 'linux/amd64, linux/arm64' : 'linux/amd64';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ³ Container Images Built Successfully\n\n` +
                    `**Registry:** \`${registry}\`\n` +
                    `**Tag:** \`${tag}\`\n` +
                    `**Architectures:** ${arch}\n\n` +
                    `### Images:\n` +
                    `- \`${registry}/${prefix}-backend:${tag}\` - FastAPI backend\n` +
                    `- \`${registry}/${prefix}-frontend:${tag}\` - React frontend\n` +
                    `- \`${registry}/${prefix}-worker:${tag}\` - Celery worker/scheduler\n\n` +
                    `**Note:** MCP Server is built separately via its own workflow.\n\n` +
                    `### Pull Images:\n` +
                    `\`\`\`bash\n` +
                    `gcloud auth configure-docker us-docker.pkg.dev\n` +
                    `docker pull ${registry}/${prefix}-backend:${tag}\n` +
                    `docker pull ${registry}/${prefix}-frontend:${tag}\n` +
                    `docker pull ${registry}/${prefix}-worker:${tag}\n` +
                    `\`\`\``
            });

      # Optional: Slack notification
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     channel-id: "#notifications"
      #     slack-message: "âœ… CC-Registry-V2 images pushed to ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}:${{ needs.generate-tag.outputs.tag }}"
      #   env:
      #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: 
      - scan-repo
      - generate-tag
      - build-backend-amd64
      - build-frontend-amd64
      - build-worker-amd64
      - build-backend-arm64
      - build-frontend-arm64
      - build-worker-arm64
      - publish-manifests
    if: always()
    steps:
      - name: Check build results
        run: |
          echo "## CC-Registry-V2 Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.generate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ env.GCR_REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "**Multi-arch:** ${{ github.event.inputs.build_multiarch == 'true' && 'Yes (amd64 + arm64)' || 'No (amd64 only)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component  | amd64 | arm64 | Manifest |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------|-------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend    | ${{ needs.build-backend-amd64.result }} | ${{ needs.build-backend-arm64.result || 'skipped' }} | ${{ needs.publish-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend   | ${{ needs.build-frontend-amd64.result }} | ${{ needs.build-frontend-arm64.result || 'skipped' }} | ${{ needs.publish-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker     | ${{ needs.build-worker-amd64.result }} | ${{ needs.build-worker-arm64.result || 'skipped' }} | ${{ needs.publish-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: MCP Server is built separately via its own workflow_" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if any required builds failed
          if [ "${{ needs.build-backend-amd64.result }}" != "success" ] || \
             [ "${{ needs.build-frontend-amd64.result }}" != "success" ] || \
             [ "${{ needs.build-worker-amd64.result }}" != "success" ]; then
            echo "âŒ Some builds failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All builds successful!" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.generate-tag.outputs.should_push }}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Pull Images:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "gcloud auth configure-docker us-docker.pkg.dev" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ needs.generate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ needs.generate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:${{ needs.generate-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "_MCP Server: See separate workflow_" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # Final notification (optional)
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: 
      - summary
      - generate-tag
    if: always()
    steps:
      - name: Set Workflow Status
        id: status
        run: |
          if [[ "${{ needs.summary.result }}" == "success" ]]; then
            echo "status=âœ… Success" >> $GITHUB_ENV
            echo "color=good" >> $GITHUB_ENV
          else
            echo "status=âŒ Failure" >> $GITHUB_ENV
            echo "color=danger" >> $GITHUB_ENV
          fi

      # Optional: Uncomment to enable Slack notifications
      # - name: Send Slack Notification
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     channel-id: "#cc-registry-builds"
      #     slack-message: |
      #       ${{ env.status }} - Workflow *${{ github.workflow }}* 
      #       Repository: *${{ github.repository }}*
      #       Branch: *${{ github.ref_name }}*
      #       Tag: *${{ needs.generate-tag.outputs.tag }}*
      #       View Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      #   env:
      #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
