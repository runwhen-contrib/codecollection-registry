name: Release CC-Registry-V2

on:
  push:
    branches:
      - main
    paths:
      - 'cc-registry-v2/**'
      - '.github/workflows/release-cc-registry-v2.yaml'

  workflow_dispatch:

env:
  GCP_PROJECT_ID: runwhen-nonprod-shared
  GCR_REGISTRY: us-docker.pkg.dev/runwhen-nonprod-shared/public-images
  IMAGE_PREFIX: cc-registry-v2

permissions:
  contents: write
  id-token: write
  pull-requests: write
  actions: read

jobs:
  create-release:
    name: Create Date-Based Release
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.create_release.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Date-based Tag and Release
        id: create_release
        run: |
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global user.name "${GITHUB_ACTOR}"

          DATE_FORMAT="+%Y-%m-%d"
          BASE_TAG=$(date "$DATE_FORMAT")

          # Find the next release number for today
          get_next_release_number() {
            local last_tag_number=$(git tag | grep "^$BASE_TAG" | awk -F '.' '{print $NF}' | sort -n | tail -1)
            if [ -z "$last_tag_number" ]; then
              echo 1
            else
              echo $((last_tag_number + 1))
            fi
          }

          NEXT_RELEASE_NUMBER=$(get_next_release_number)
          NEW_TAG="$BASE_TAG.$NEXT_RELEASE_NUMBER"

          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"
          echo "Created and pushed tag $NEW_TAG"

          gh release create "$NEW_TAG" --generate-notes
          echo "release_tag=$NEW_TAG" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: [create-release]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: cc-registry-v2/backend
          file: cc-registry-v2/backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ needs.create-release.outputs.release_tag }}
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [create-release]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: cc-registry-v2/frontend
          file: cc-registry-v2/frontend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ needs.create-release.outputs.release_tag }}
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  build-worker:
    name: Build Worker
    runs-on: ubuntu-latest
    needs: [create-release]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Copy backend requirements to worker context
        run: cp cc-registry-v2/backend/requirements.txt cc-registry-v2/worker/requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Worker
        uses: docker/build-push-action@v5
        with:
          context: cc-registry-v2/worker
          file: cc-registry-v2/worker/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:${{ needs.create-release.outputs.release_tag }}
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  # Trigger test environment deployment with the release tag
  deploy-to-test:
    name: Deploy Release to Test
    runs-on: ubuntu-latest
    needs: [create-release, build-backend, build-frontend, build-worker]
    steps:
      - name: Trigger registry-test image update
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'runwhen',
              repo: 'infra-flux-nonprod-shared',
              workflow_id: 'update-registry-test-images.yaml',
              ref: 'main',
              inputs: {
                image_tag: '${{ needs.create-release.outputs.release_tag }}'
              }
            });
            console.log('Triggered update-registry-test-images.yaml with tag: ${{ needs.create-release.outputs.release_tag }}');

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [create-release, build-backend, build-frontend, build-worker, deploy-to-test]
    if: always()
    steps:
      - name: Build summary
        run: |
          TAG="${{ needs.create-release.outputs.release_tag }}"
          echo "## CC-Registry-V2 Release: ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Release Tag | \`${TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ needs.build-worker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Deploy | ${{ needs.deploy-to-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-backend.result }}" = "success" ] && \
             [ "${{ needs.build-frontend.result }}" = "success" ] && \
             [ "${{ needs.build-worker.result }}" = "success" ]; then
            echo "### Images" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${TAG}" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${TAG}" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_PREFIX }}-worker:${TAG}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some builds failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
