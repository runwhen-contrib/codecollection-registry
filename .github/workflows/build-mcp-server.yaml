name: Build MCP Server Image (PR)

on:
  pull_request:
    paths:
      - 'mcp-server/**'
      - '.github/workflows/build-mcp-server.yaml'

  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      tag:
        description: 'Custom tag for images (default: branch-sha)'
        required: false
        type: string
      trigger_test_deploy:
        description: 'Trigger test environment deployment'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  GCP_PROJECT_ID: runwhen-nonprod-shared
  GCR_REGISTRY: us-docker.pkg.dev/runwhen-nonprod-shared/public-images
  IMAGE_NAME: runwhen-mcp-server

permissions:
  contents: read
  id-token: write
  pull-requests: write
  actions: read

jobs:
  generate-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      should_push: ${{ steps.push.outputs.should_push }}
    steps:
      - name: Generate tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="$(echo $GITHUB_HEAD_REF$GITHUB_REF_NAME | sed 's/[^a-zA-Z0-9]/-/g')-${GITHUB_SHA::8}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Determine push behavior
        id: push
        run: |
          if [ "${{ github.event.inputs.push_images }}" = "false" ]; then
            echo "should_push=false" >> $GITHUB_OUTPUT
          else
            echo "should_push=true" >> $GITHUB_OUTPUT
          fi

  build-mcp-server:
    name: Build MCP Server
    runs-on: ubuntu-latest
    needs: [generate-tag]
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push MCP Server
        uses: docker/build-push-action@v5
        with:
          context: mcp-server
          file: mcp-server/Dockerfile
          platforms: linux/amd64
          push: ${{ needs.generate-tag.outputs.should_push == 'true' }}
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.generate-tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  deploy-to-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [generate-tag, build-mcp-server]
    if: needs.generate-tag.outputs.should_push == 'true'
    steps:
      - name: Trigger registry-test image update
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const tag = '${{ needs.generate-tag.outputs.tag }}';
            await github.rest.actions.createWorkflowDispatch({
              owner: 'runwhen',
              repo: 'infra-flux-nonprod-shared',
              workflow_id: 'update-registry-test-images.yaml',
              ref: 'main',
              inputs: {
                mcp_server_tag: tag,
                pr_number: String(context.issue?.number || '')
              }
            });
            console.log(`Triggered test deploy for MCP server with tag: ${tag}`);

  comment-on-pr:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [generate-tag, build-mcp-server, deploy-to-test]
    if: always() && github.event_name == 'pull_request' && needs.generate-tag.outputs.should_push == 'true'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ needs.generate-tag.outputs.tag }}';
            const registry = '${{ env.GCR_REGISTRY }}';
            const image = '${{ env.IMAGE_NAME }}';
            const buildOk = '${{ needs.build-mcp-server.result }}' === 'success';
            const deployOk = '${{ needs.deploy-to-test.result }}' === 'success';

            let body = `## MCP Server Image Built\n\n` +
              `**Tag:** \`${tag}\`\n` +
              `**Build:** ${buildOk ? '✅ Image pushed' : '❌ Build failed'}\n` +
              `**Test Deploy:** ${deployOk ? '✅ Triggered' : '⚠️ Not triggered'}\n\n` +
              `| Image | Tag |\n` +
              `|-------|-----|\n` +
              `| \`${image}\` | \`${tag}\` |\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
