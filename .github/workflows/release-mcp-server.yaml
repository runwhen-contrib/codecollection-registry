name: Release MCP Server

on:
  push:
    branches:
      - main
    paths:
      - 'mcp-server/**'
      - '.github/workflows/release-mcp-server.yaml'

  workflow_dispatch:

env:
  GCP_PROJECT_ID: runwhen-nonprod-shared
  GCR_REGISTRY: us-docker.pkg.dev/runwhen-nonprod-shared/public-images
  IMAGE_NAME: runwhen-mcp-server

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  create-release:
    name: Create Date-Based Release
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.create_release.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Date-based Tag and Release
        id: create_release
        run: |
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global user.name "${GITHUB_ACTOR}"

          DATE_FORMAT="+%Y-%m-%d"
          BASE_TAG=$(date "$DATE_FORMAT")

          get_next_release_number() {
            local last_tag_number=$(git tag | grep "^$BASE_TAG" | awk -F '.' '{print $NF}' | sort -n | tail -1)
            if [ -z "$last_tag_number" ]; then
              echo 1
            else
              echo $((last_tag_number + 1))
            fi
          }

          NEXT_RELEASE_NUMBER=$(get_next_release_number)
          NEW_TAG="$BASE_TAG.$NEXT_RELEASE_NUMBER"

          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"
          echo "Created and pushed tag $NEW_TAG"

          gh release create "$NEW_TAG" --generate-notes
          echo "release_tag=$NEW_TAG" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

  build-mcp-server:
    name: Build MCP Server
    runs-on: ubuntu-latest
    needs: [create-release]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_PROVIDER }}
          service_account: ${{ secrets.RUNWHEN_NONPROD_SHARED_WI_SA }}

      - name: Configure Docker for GCR
        run: gcloud --quiet auth configure-docker us-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push MCP Server
        uses: docker/build-push-action@v5
        with:
          context: mcp-server
          file: mcp-server/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.create-release.outputs.release_tag }}
            ${{ env.GCR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref }}

  deploy-to-test:
    name: Deploy Release to Test
    runs-on: ubuntu-latest
    needs: [create-release, build-mcp-server]
    steps:
      - name: Trigger registry-test image update
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const tag = '${{ needs.create-release.outputs.release_tag }}';
            await github.rest.actions.createWorkflowDispatch({
              owner: 'runwhen',
              repo: 'infra-flux-nonprod-shared',
              workflow_id: 'update-registry-test-images.yaml',
              ref: 'main',
              inputs: {
                environment: 'test',
                mcp_server_tag: tag,
                branch_prefix: 'chore/registry-image-update'
              }
            });
            console.log(`Triggered test deploy for MCP server with release tag: ${tag}`);

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [create-release, build-mcp-server, deploy-to-test]
    if: always()
    steps:
      - name: Build summary
        run: |
          TAG="${{ needs.create-release.outputs.release_tag }}"
          echo "## MCP Server Release: ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Release Tag | \`${TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Server | ${{ needs.build-mcp-server.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Deploy | ${{ needs.deploy-to-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-mcp-server.result }}" = "success" ]; then
            echo "### Image" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ env.GCR_REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
